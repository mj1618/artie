# Task: Shareable Invite Link Flow

## What to Build

Replace the email-based invite system with a shareable invite link flow. Currently, owners invite by email and users must already be logged in to see and accept invites. Instead, owners should generate a link they can share (via Slack, email, etc.). When someone opens the link, they see a dedicated invite page where they can sign up or sign in to join the team.

## Schema Changes

**File: `convex/schema.ts`**

Add an `inviteLinks` table alongside (or replacing) the existing `invites` table:

```typescript
inviteLinks: defineTable({
  teamId: v.id("teams"),
  code: v.string(),           // Unique random code for the URL
  createdBy: v.string(),      // userId of the owner who created it
  createdAt: v.number(),
  expiresAt: v.optional(v.number()),  // Optional expiration
  maxUses: v.optional(v.number()),    // Optional usage limit
  useCount: v.number(),              // How many times used
})
  .index("by_code", ["code"])
  .index("by_teamId", ["teamId"]),
```

Keep the existing `invites` table as-is for backward compatibility — don't remove it.

## Backend Changes

**File: `convex/teams.ts`**

Add these new functions:

1. **`createInviteLink`** (mutation) — Owner generates an invite link. Creates a random 8-char alphanumeric code. Returns the code.
2. **`getInviteByCode`** (query) — Public query (no auth required) that looks up an invite link by code and returns the team name + whether it's still valid. Do NOT require authentication since the user viewing the link may not be logged in yet.
3. **`acceptInviteLink`** (mutation) — Authenticated user accepts an invite link by code. Checks: not expired, not at max uses, user not already a member. Increments `useCount`, creates `teamMembers` record.
4. **`listInviteLinks`** (query) — Owner lists active invite links for their team.
5. **`deleteInviteLink`** (mutation) — Owner revokes an invite link.

## Frontend Changes

### New Route: `/invite/[code]/page.tsx`

**File: `src/app/invite/[code]/page.tsx`**

This is a PUBLIC route (outside the `(dashboard)` group, no auth layout required). It should:

1. Read the `code` from the URL params
2. Call `getInviteByCode` to fetch invite details (team name, validity)
3. Show different states:
   - **Loading**: Spinner while fetching
   - **Invalid/expired**: "This invite link is no longer valid" with a CTA to go home
   - **Valid + not logged in**: Show team name, "You've been invited to join [TeamName]!" with "Sign up to join" and "Already have an account? Sign in" buttons that redirect to `/signup?redirect=/invite/[code]` and `/login?redirect=/invite/[code]`
   - **Valid + logged in + not a member**: Show team name, "Join [TeamName]" button that calls `acceptInviteLink`
   - **Valid + logged in + already a member**: "You're already a member of [TeamName]!" with link to dashboard
4. After successful join, redirect to `/home`

### Update Auth Pages

**Files: `src/app/(auth)/login/page.tsx` and `src/app/(auth)/signup/page.tsx`**

Add support for a `redirect` query parameter. After successful login/signup, redirect to the URL in `redirect` param instead of always going to `/home`. This enables the invite -> signup -> auto-join flow.

### Update Team Management UI

**File: `src/app/(dashboard)/team/[teamId]/page.tsx`**

In the existing InviteSection component, add:
- A "Generate invite link" button that calls `createInviteLink`
- Display generated links with a "Copy" button (format: `{NEXT_PUBLIC_APP_URL}/invite/{code}`)
- List active invite links with use counts and delete buttons

Keep the existing email-based invite form as an alternative.

## How to Verify

1. **TypeScript**: Run `npx tsc --noEmit` — no errors
2. **Codegen**: Run `npx convex dev --once` — schema deploys successfully
3. **Browser testing**:
   - Log in as owner, go to team settings
   - Click "Generate invite link" — link appears with copy button
   - Copy link and open in an incognito/private window (not logged in)
   - See invite page with team name and sign up/sign in buttons
   - Click "Sign up", create account, get redirected back to invite page
   - Click "Join", verify redirect to `/home` and team appears in sidebar
   - Go back to owner's team page — invite link shows use count incremented
   - Try the link again as a member — see "already a member" message
   - Owner deletes the invite link — link becomes invalid

## Notes

- Use `crypto.randomUUID().slice(0, 8)` or similar for generating codes (server-side in Convex mutation)
- The `/invite/[code]` page should be a client component (`"use client"`) since it needs `useConvexAuth` and `useMutation`
- For the `getInviteByCode` query, it needs to work without authentication. Use a regular `query` but don't call `getAuthUserId` as a gate — just don't require it. You can optionally check if the current user is authenticated to show different UI states.

---

## Completion Summary

### Agent: 0bccf2f4

### Files Changed
- **`convex/schema.ts`** — Added `inviteLinks` table with `by_code` and `by_teamId` indexes
- **`convex/teams.ts`** — Added 5 new functions: `createInviteLink`, `getInviteByCode`, `acceptInviteLink`, `listInviteLinks`, `deleteInviteLink`
- **`src/app/invite/[code]/page.tsx`** — New public invite page with loading, invalid, not-logged-in, join, and already-member states
- **`src/app/(auth)/login/page.tsx`** — Added `redirect` query param support, wrapped in Suspense for Next.js 16 compatibility
- **`src/app/(auth)/signup/page.tsx`** — Added `redirect` query param support, wrapped in Suspense for Next.js 16 compatibility
- **`src/app/(dashboard)/team/[teamId]/page.tsx`** — Added `InviteLinkSection` component with generate, copy, and delete functionality; renamed email invite section to "Invite by Email"

### What Was Built
- Full shareable invite link flow: owners generate 8-char alphanumeric invite codes
- Public `/invite/[code]` page that handles all user states (unauthenticated, authenticated non-member, already a member, invalid/expired link)
- Auth pages now support `?redirect=` parameter for seamless invite -> signup/login -> accept flow
- Team management UI shows invite links with use counts, copy-to-clipboard, and delete buttons
- Existing email-based invite system preserved alongside new link system

### Verification
- `npx tsc --noEmit` — passes with 0 errors
- `npx convex dev --once` — schema deployed successfully with new indexes
- Browser tested: login, team management, invite link generation, invite page (already-a-member and invalid states) all working correctly
